pipeline {
    agent any
    
    stages {
        stage('Build') {
            steps {
                echo 'Maven is building your code...'
            }
        }
        stage('Unit and Integration Tests') {
            steps {
                echo 'Running unit tests with JavaUnit...'
                echo 'Running integration tests with Selenium...'
            }
        }
        stage('Code Analysis') {
            steps {
                echo 'Analyzing code quality with SonarQube...'
            }
        }
        stage('Security Scan') {
            steps {
                echo 'Scanning for vulnerabilities with SAST scanner...'
            }
        }
        stage('Deploy to Staging') {
            steps {
                echo 'Deploying application to staging server using AWS...'
            }
        }
    }

    post {
        always {
            script {
                // Capture the console output (pipeline logs) and save it to a file
                def logFile = "build-log-${currentBuild.number}.txt"
                def logContent = currentBuild.rawBuild.getLog(1000).join("\n")
                writeFile file: logFile, text: logContent

                // Archive the log file for Jenkins
                archiveArtifacts artifacts: logFile

                // Send the email with the log file attached
                emailext(
                    to: 'disadimethasa@gmail.com',
                    subject: "Pipeline ${currentBuild.currentResult} - Build #${currentBuild.number}",
                    body: "The pipeline has completed with result: ${currentBuild.currentResult}. Please find the build logs attached.",
                    attachmentsPattern: logFile
                )
            }
        }
    }
}
